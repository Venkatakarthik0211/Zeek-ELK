# AWS KMS Architecture and Functionality

## 1. AWS KMS Architecture

AWS Key Management Service (KMS) is a managed service that makes it easy to create and control cryptographic keys used to encrypt data. The architecture of AWS KMS involves several components and processes:

### Key Components

- **Customer Master Keys (CMKs)**: These are the primary resources in KMS. CMKs can be either symmetric or asymmetric. Symmetric CMKs use a single key for encryption and decryption, while asymmetric CMKs use a public-private key pair.
- **Data Keys**: These are keys generated by KMS and used to encrypt data. They are encrypted using a CMK and can be used outside of KMS.
- **KMS API**: AWS provides a set of APIs to interact with KMS for various operations like key creation, encryption, decryption, and key management.
- **KMS Service**: The underlying infrastructure that manages the creation, rotation, and usage of keys. This includes hardware security modules (HSMs) which provide physical security for key storage.

### Key Processes

- **Key Creation**: When you create a CMK, it is generated within a KMS-managed HSM and is never exposed in plaintext outside the HSM.
- **Encryption and Decryption**: Data is encrypted using data keys, which are in turn encrypted by CMKs. KMS handles the generation and management of these data keys.
- **Key Management**: KMS allows for the management of key policies, rotation of CMKs, and auditing of key usage through AWS CloudTrail.

## 2. Encrypted Data Storage in KMS

In AWS KMS, data keys and other cryptographic material are always encrypted and stored securely within KMS. When you use KMS to encrypt data:

- The data is encrypted with a data key.
- The data key is then encrypted with a CMK.
- The encrypted data key and the encrypted data are stored together, but the plaintext data key is never exposed outside KMS.

## 3. Key Storage Size Limitation

AWS KMS has a size limitation for the keys it stores. Specifically:

- KMS will store keys up to 4KB in size.
- This size limitation is primarily for CMKs and other cryptographic material managed by KMS.

## 4. FIPS 140-2 Level 2 and its Relation to KMS

### FIPS 140-2 Level 2 Overview

FIPS 140-2 is a U.S. government standard that specifies the security requirements for cryptographic modules. The standard has different levels, with Level 2 providing a moderate level of security. Key features of FIPS 140-2 Level 2 include:

- **Tamper-Evidence**: Cryptographic modules must show evidence of tampering.
- **Role-Based Authentication**: Users must be authenticated before accessing the cryptographic module.
- **Enhanced Security**: The standard includes additional requirements for physical security and operating system security.

### Relation to AWS KMS

AWS KMS uses HSMs that are validated at FIPS 140-2 Level 2. This means:

- The HSMs used by KMS meet the security requirements set by FIPS 140-2 Level 2.
- Data keys and CMKs are stored within these validated HSMs, ensuring a high level of security.
- Organizations requiring compliance with FIPS 140-2 Level 2 can rely on AWS KMS for their cryptographic needs.

# Key Concepts

- **KMS Keys are isolated to a region & never leave**:
  - Each KMS key is created and used within a specific AWS region. These keys do not leave their region of origin, ensuring data sovereignty and compliance with regional regulations.

- **AWS Owned & Customer Owned**:
  - KMS keys can be owned by AWS or the customer. AWS-owned keys are managed entirely by AWS, while customer-owned keys provide more control and customization options.

- **With Customer ownedâ€¦ AWS Managed or Customer Managed KEYS**:
  - Customer-owned keys can be either AWS managed or customer managed:
    - **AWS Managed**: AWS handles the management tasks such as key rotation and deletion.
    - **Customer Managed**: Customers are responsible for managing the keys, giving them more control over key policies and permissions.

- **Customer managed keys are more configurable**:
  - Customer managed keys offer greater flexibility in terms of configuration, including setting key policies, enabling key rotation, and defining usage permissions.

- **KMS Keys support rotation**:
  - AWS KMS supports automatic key rotation for symmetric CMKs, helping enhance security by regularly rotating the cryptographic material.

- **Backing Key (and previous backing keys)**:
  - A backing key is the cryptographic material used by a CMK. When a key is rotated, new backing keys are generated, but previous backing keys are retained to decrypt data encrypted with older keys.

- **Aliases**:
  - Aliases are user-friendly names that can be associated with CMKs. They provide an easy way to reference keys without using their complex key IDs.

## AWS KMS Key Policies

### What are Key Policies in AWS KMS?
Key policies in AWS KMS (Key Management Service) are JSON-based policies that define who can use and manage KMS keys and under what conditions.

### How IAM and KMS Policies Work Together
IAM policies and KMS key policies work together to grant permissions: IAM policies can allow access to KMS actions, but the KMS key policy must also permit the action for it to be effective. Both policies need to grant the required permissions for access.

### Properties of AWS KMS Policies
- **Fine-Grained Access Control**: Define detailed permissions at a granular level.
- **Integration with IAM**: Work in conjunction with IAM policies for robust access control.
- **Policy Structure**: JSON format, similar to IAM policies, including statements, actions, resources, and conditions.

```json 
{
  "Sid": "Enable IAM User Permissions",
  "Effect": "Allow",
  "Principal": {
    "AWS": "arn:aws:iam::111122223333:root"
  },
  "Action": "kms:*",
  "Resource": "*"
}
```

```json 
{
  "Version": "2012-10-17",
  "Statement": {
    "Effect": "Allow",
    "Action": [
      "kms:Encrypt",
      "kms:Decrypt"
    ],
    "Resource": [
      "arn:aws:kms:*:111122223333:key/*"
    ]
  }
}

```

```sh
echo "I want to complete sysops Administrator" > battleplans.txt

echo "These commands are to encrypt "
aws kms encrypt \
    --key-id alias/s3keys \
    --plaintext fileb://battleplans.txt \
    --output text \
    --query CiphertextBlob \
    | base64 --decode > not_battleplans.enc 

aws kms decrypt \
    --ciphertext-blob fileb://not_battleplans.enc \
    --output text \
    --query Plaintext | base64 --decode > decryptedplans.txt
```
